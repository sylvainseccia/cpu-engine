#pragma once

class Ship;

class App : public cpu_engine
{
public:
	App();
	virtual ~App();

	static App* GetInstance() { return s_pApp; }

	void SpawnMissile();
	void SpawnMissileWithMouse();

	void OnStart() override;
	void OnUpdate() override;
	void OnExit() override;
	void OnPreRender() override;
	void OnPostRender() override;

	static void MissileShader(cpu_ps_io& io);
	static void RockShader(cpu_ps_io& io);

private:
	inline static App* s_pApp = nullptr;

	// Resources
	cpu_font m_font;
	cpu_mesh m_meshShip;
	cpu_mesh m_meshMissile;
	cpu_mesh m_meshSphere;
	cpu_texture m_texture;

	// UI
	cpu_sprite* m_pSprite;

	// Shader
	cpu_material m_materialShip;
	cpu_material m_materialMissile;
	cpu_material m_materialRock;

	// 3D
	Ship* m_pShip;
	std::list<cpu_entity*> m_missiles;
	float m_missileSpeed;
	cpu_entity* m_pBall;
	cpu_entity* m_pRock;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class Ship
{
public:
	Ship();
	~Ship();

	void Create(cpu_mesh* pMesh, cpu_material* pMaterial);
	void Destroy();

	void Update();

	cpu_entity* GetEntity() { return m_pEntity; }
	cpu_fsm<Ship>* GetFSM() { return m_pFSM; }

protected:
	cpu_entity* m_pEntity;
	cpu_fsm<Ship>* m_pFSM;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct StateGlobal : public cpu_state<Ship>
{
	static inline int id;
	static void OnExecute(Ship& cur);
};

struct StateIdle : public cpu_state<Ship>
{
	static inline int id;
	static void OnEnter(Ship& cur, int from);
	static void OnExecute(Ship& cur);
	static void OnExit(Ship& cur, int to);
};

struct StateBlink : public cpu_state<Ship>
{
	static inline int id;
	static void OnEnter(Ship& cur, int from);
	static void OnExecute(Ship& cur);
	static void OnExit(Ship& cur, int to);
};
