#pragma once

struct cpu_particle_physics
{
	float gx;
	float gy;
	float gz;
	float drag;					// 0.. (ex: 1..5)
	float maxSpeed;				// 0 = no clamp

	float minX;
	float minY;
	float minZ;
	float maxX;
	float maxY;
	float maxZ;
	bool useBounds;
	float bounce;				// 0..1

	cpu_particle_physics();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_particle_data
{
	int maxCount;
	int alive;

	void* blob;
	int size;

	float* px;
	float* py;
	float* pz;

	float* vx;
	float* vy;
	float* vz;

	float* age;
	float* duration;
	float* invDuration;
	//ui32* seed;

	float* r;
	float* g;
	float* b;

	// Render
	ui32* tile;
	ui32* sort;
	ui16* sx;
	ui16* sy;
	float* sz;

	cpu_particle_data();
	~cpu_particle_data();
	void Reset();

	void Create(int maxP);
	void Destroy();
	void UpdateAge();
	void UpdatePhysics(int min, int max);
	inline void ApplyBounds(float& px, float& py, float& pz, float& vx, float& vy, float& vz, const cpu_particle_physics& phys);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_particle_emitter : public cpu_object
{
	float density;			// particles / second / pixel²
	float spawnRadius;		// volume d'émission

	XMFLOAT3 pos;			// world position
	XMFLOAT3 dir;			// normalized direction
	XMFLOAT3 colorMin;		// color range
	XMFLOAT3 colorMax;		// color range
	float durationMin;		// duration range
	float durationMax;		// duration range
	float speedMin;			// speed range
	float speedMax;			// speed range
	float spread;			// dispersion directionnelles
							// 0		=> jet laser, pluie parfaitement verticale, rayon
							// 0.05-0.2 => fumée canalisée, vapeur, souffle
							// 0.3-0.7	=> feu, poussière, étincelles
							// >1		=> explosion, chaos

private:
	float accum;

public:
	cpu_particle_emitter();

	void Update();
};
