#pragma once

struct cpu_transform
{
	// Position
	XMFLOAT3 pos;

	// Scaling
	XMFLOAT3 sca;

	// Rotation
	XMFLOAT3 dir;
	XMFLOAT3 right;
	XMFLOAT3 up;
	XMFLOAT4 quat;
	XMFLOAT4X4 rot;

private:
	// World
	bool worldUpdated;
	XMFLOAT4X4 world;
	bool invWorldUpdated;
	XMFLOAT4X4 invWorld;
	
public:
	cpu_transform();

	void Identity();
	void UpdateWorld();
	void UpdateInvWorld();
	void ResetFlags() { worldUpdated = invWorldUpdated = false; }
	XMFLOAT4X4& GetWorld();
	XMFLOAT4X4& GetInvWorld();
	void SetScaling(float scale);
	void Scale(float scale);
	void SetPosition(float x, float y, float z);
	void Move(float dist);
	void OrbitAroundAxis(XMFLOAT3& center, XMFLOAT3& axis, float radius, float angle);
	void ResetRotation();
	void SetRotation(cpu_transform& transform);
	void SetYPR(float yaw, float pitch = 0.0f, float roll = 0.0f);
	void AddYPR(float yaw, float pitch = 0.0f, float roll = 0.0f);
	void LookAt(float x, float y, float z);
	void LookTo(float ndx, float ndy, float ndz);
	void LookTo(XMFLOAT3& ndir);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_entity : public cpu_object
{
	cpu_mesh* pMesh;
	cpu_transform transform;
	XMFLOAT3 view;
	cpu_material* pMaterial;
	float lifetime;
	ui32 tile;
	float radius;
	cpu_aabb aabb;
	cpu_obb obb;
	cpu_rectangle box;
	bool clipped;
	byte depth;
	bool visible;

	cpu_entity();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_frustum
{
	XMFLOAT4 planes[6]; // left, right, bottom, top, near, far

	cpu_frustum();

	void FromViewProj(const XMFLOAT4X4& viewProj);
	bool Intersect(const XMFLOAT3& center, float radius);
	XMVECTOR XM_CALLCONV NormalizePlane(FXMVECTOR p);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_camera
{
	float fov;
	float near;
	float far;
	XMFLOAT4X4 matView;
	XMFLOAT4X4 matProj;
	XMFLOAT4X4 matViewProj;
	cpu_transform transform;
	cpu_frustum frustum;

	cpu_camera();

	void UpdateProjection(float aspectRatio);
	void Update();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_hit
{
	float dist;
	XMFLOAT3 pt;
};
