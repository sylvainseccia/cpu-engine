#pragma once

struct VEC3_CMP
{
	bool operator()(const XMFLOAT3& a, const XMFLOAT3& b) const
	{
		const float eps = 0.001f;
		if ( fabsf(a.x-b.x)>eps )
			return a.x<b.x;
		if ( fabsf(a.y-b.y)>eps )
			return a.y<b.y;
		return a.z<(b.z-eps);
	}
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_vertex
{
	XMFLOAT3 pos;
	XMFLOAT3 color;
	XMFLOAT3 normal;

	cpu_vertex();
	void Identity();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_triangle
{
	cpu_vertex v[3];

	cpu_triangle();
	void Identity();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_rectangle
{
	XMFLOAT2 min;
	XMFLOAT2 max;

	cpu_rectangle();
	void Zero();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_aabb
{
	XMFLOAT3 min;
	XMFLOAT3 max;

	cpu_aabb();
	cpu_aabb& operator=(const cpu_obb& obb);
	void Zero();
	bool XM_CALLCONV ToScreen(cpu_rectangle& out, FXMMATRIX wvp, float renderWidth, float renderHeight);
	bool Contains(const XMFLOAT3& p);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_obb
{
	XMFLOAT3 pts[8];

	cpu_obb();
	cpu_obb& operator=(const cpu_aabb& aabb);
	void Zero();
	void XM_CALLCONV Transform(FXMMATRIX m);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_ray
{
	XMFLOAT3 pos;
	XMFLOAT3 dir;

	cpu_ray();
	void Identity();
	void XM_CALLCONV ToLocal(cpu_ray& out, FXMMATRIX invWorld);
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_mesh
{
	std::vector<cpu_triangle> triangles;
	float radius;
	cpu_aabb aabb;

	cpu_mesh();
	~cpu_mesh() = default;
	void Clear();
	void AddTriangle(XMFLOAT3& a, XMFLOAT3& b, XMFLOAT3& c, XMFLOAT3& color);
	void AddFace(XMFLOAT3& a, XMFLOAT3& b, XMFLOAT3& c, XMFLOAT3& d, XMFLOAT3& color);
	void Optimize();
	void CalculateNormals();
	void CalculateBox();
	void CreatePlane(float width = 1.0f, float height = 1.0f, XMFLOAT3 color = CPU_WHITE);
	void CreateCube(float halfSize = 0.5f, XMFLOAT3 color = CPU_WHITE);
	void CreateCircle(float radius = 0.5f, int count = 6, XMFLOAT3 color = CPU_WHITE);
	void CreateSphere(float radius = 0.5f, int stacks = 5, int slices = 5, XMFLOAT3 color1 = CPU_WHITE, XMFLOAT3 color2 = CPU_WHITE);
	void CreateSpaceship();
};
