#include "pch.h"

cpu_player::cpu_player()
{
	pSound = nullptr;

	loop = false;
	pause = false;
	volume = 1.0f;
	pan = 0.0f;

	current = 0;
	previous = 0;
}

cpu_player::~cpu_player()
{
	Stop();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_player::Update()
{
	if ( IsPlaying()==false )
		return;

	XAUDIO2_VOICE_STATE state;
	pSound->pVoice->GetState(&state);
	current += state.SamplesPlayed - previous;
	previous = state.SamplesPlayed;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_player::SetSound(cpu_sound* pSnd)
{
	Stop();
	pSound = pSnd;
}

void cpu_player::SetLoop(bool isLoop)
{
	loop = isLoop;
}

bool cpu_player::IsLoop()
{
	return loop;
}

void cpu_player::SetVolume(float level)
{
	level = cpu::Clamp(level);
	if ( level==volume )
		return;

	volume = level;
	UpdateVolume();
}

float cpu_player::GetVolume()
{
	return volume;
}

void cpu_player::SetPan(float level)
{
	level = cpu::Clamp(level, -1.0f, 1.0f);
	if ( level==pan )
		return;

	pan = level;
	UpdateVolume();
}

float cpu_player::GetPan()
{
	return pan;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cpu_player::Play()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return false;

	Stop();

	pSound->buffer.LoopCount = loop ? XAUDIO2_LOOP_INFINITE : 0;
	//buffer.PlayBegin = 0;

	if ( FAILED(pSound->pVoice->SubmitSourceBuffer(&pSound->buffer)) )
		return false;

	UpdateVolume();

	if ( FAILED(pSound->pVoice->Start(0)) )
		return false;

	return true;
}

bool cpu_player::Pause()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return false;

	if ( pause )
		return false;

	if ( IsPlaying()==false )
		return false;

	pSound->pVoice->Stop(0);
	pause = true;
	return true;
}

bool cpu_player::Resume()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return false;

	if ( pause==false )
		return false;

	if ( FAILED(pSound->pVoice->Start(0)) )
		return false;

	pause = false;
	return true;
}

void cpu_player::Stop()
{
	if ( pSound && pSound->pVoice )
	{
		pSound->pVoice->Stop(0);
		pSound->pVoice->FlushSourceBuffers();
	}

	pause = false;
	current = 0;
	previous = 0;
}

bool cpu_player::IsPlaying()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return false;

	XAUDIO2_VOICE_STATE state;
	pSound->pVoice->GetState(&state);
	return state.BuffersQueued>0;
}

bool cpu_player::IsPause()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return false;

	return pause;
}

float cpu_player::GetPosition()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return 0.0f;

	return current/(float)pSound->format.nSamplesPerSec;	
}

ui64 cpu_player::GetSamplePosition()
{
	return current;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_player::UpdateVolume()
{
	if ( pSound==nullptr || pSound->pVoice==nullptr )
		return;

	if ( pSound->format.nChannels==2 )
	{
		float volumes[2];
		volumes[0] = (pan<=0.0f ? 1.0f : 1.0f-pan) * volume;
		volumes[1] = (pan>=0.0f ? 1.0f : 1.0f+pan) * volume;
		pSound->pVoice->SetChannelVolumes(2, volumes);
	}
	else
	{
		pSound->pVoice->SetVolume(volume);
	}
}
